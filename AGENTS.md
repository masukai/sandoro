# AGENTS.md

Speak in Japanese.

このドキュメントは、Claude Code、GitHub Copilot、Codex などの生成AIエージェントが sandoro プロジェクトで作業する際の共通ガイドラインです。

## プロジェクト概要

sandoro は、ASCII アートアニメーション付きのポモドーロタイマーです：
- **CLI 版**: Rust + ratatui + crossterm + SQLite
- **Web 版**: React + TypeScript + Tailwind CSS + PWA
- **ビジネスモデル**: Freemium（無料版 + Pro版 ¥500/月）

## ドキュメントの役割
- `README.md`: プロジェクト全体の概要とクイックスタート（人とAIの共通入口）
- `PLAN.md`: 実装計画書（目標、システム構成、実装フェーズ）
- `CONTRIBUTING.md`: 人が主体で運用する開発フローとレビュープロセス
- `RUNBOOK.md`: 恒久ルールと運用手順の一次情報（**必ず遵守**）
- `CLAUDE.md`: Claude Code 固有の補足。Claude 以外のエージェントも内容を参考にしてよい

## 共通原則

### 1. 人間のオーナーシップを尊重する
- 意思決定の前提に不明点があれば必ず確認する
- 複数の選択肢がある場合は、トレードオフを説明して人に判断を仰ぐ
- 破壊的な操作（リソース削除、本番デプロイなど）は明示的な指示がある場合のみ実行

### 2. RUNBOOK を最優先で遵守する
- 作業開始前に RUNBOOK.md を必ず読む
- RUNBOOK に書かれていない恒久ルールを導入する前に「RUNBOOK.md に追記しますか？」と質問する
- RUNBOOK と矛盾する独自ルールを追加しない

### 3. PLAN を理解して作業する
- 実装開始前に PLAN.md を読み、プロジェクトの目標と実装フェーズを理解する
- 現在どのフェーズにいるか確認し、段階的に実装を進める
- フェーズ間の依存関係を意識して作業する

### 4. 変更履歴と意図を明確に残す
- 変更は原則 Pull Request 経由で共有する
- コミットメッセージは日本語で、目的と影響が分かるように記述する
- PR には背景・変更内容・テスト結果・影響範囲を必ず記載する

### 5. セキュリティとデータ保護
- 秘密情報（鍵・トークン・個人情報）をリポジトリへ保存しない
- 認証情報は環境変数で管理する
- `.gitignore` を確認し、秘匿情報が含まれないようにする
- Supabase の認証情報は特に注意

### 6. ツールバージョンを統一する
- コマンド実行は `mise run ...` に統一し、mise で管理されたツールを使用する
- カスタム操作が必要な場合は事前に理由を共有し、mise タスクへの追加を検討する
- 直接コマンドを実行すると、異なるバージョンが使われる可能性があるため避ける

### 7. ドキュメントを常に最新に保つ
- コード変更がドキュメントに影響する場合は、対応するドキュメントも同時に更新する
- 更新が必要なドキュメントが不明な場合は人に確認する
- PR には「以下のドキュメントを更新しました」とリストアップして共有する

## 作業プロセス

### 準備フェーズ
1. `README.md` の「クイックスタート」で環境を整える
2. `mise install` を実行し、必要なツールをインストールする
3. `PLAN.md` を読み、プロジェクトの目標と現在のフェーズを理解する
4. `RUNBOOK.md` を読み、恒久ルールと標準ワークフローを確認する

### 開発フェーズ
1. **作業前の確認**
   - PLAN.md で現在のフェーズと実装すべき機能を確認
   - RUNBOOK.md の「標準ワークフロー」に従って作業を進める
   - 不明点や判断が必要な事項は人に確認する

2. **実装**
   - コードを書く際は、既存のコーディング規約に従う
   - テストコードも同時に作成する
   - ドキュメントに影響がある場合は同時に更新する

3. **検証**
   - RUNBOOK の「リリースチェックリスト」を満たすまで進めない
   - テストを実行し、すべてパスすることを確認する
   - 影響範囲を確認し、想定外の変更がないかチェックする

### ハンドオフフェーズ
1. **PR作成**
   - 背景・変更内容・テスト結果・影響範囲を記載する
   - 更新したドキュメントをリストアップする
   - ロールバック方法を簡潔にまとめる

2. **レビュー対応**
   - レビューコメントに対して丁寧に回答する
   - 修正が必要な場合は速やかに対応する
   - 合意が得られない場合は、複数案とトレードオフを提示する

## sandoro 固有のガイドライン

### CLI 開発時の注意
- ratatui と crossterm の API を正しく使用する
- SQLite のマイグレーションは `shared/schema.sql` を参照
- ASCII アートは `cli/src/icons/` 以下に配置
- テーマは `shared/themes/*.toml` から読み込む

### Web 開発時の注意
- React のベストプラクティスに従う
- Zustand でグローバル状態を管理
- Tailwind CSS でスタイリング
- PWA 対応のため Service Worker を適切に設定
- IndexedDB のスキーマは `shared/schema.sql` を参照

### 共有リソース
- テーマファイルは TOML 形式で `shared/themes/` に配置
- データベーススキーマは `shared/schema.sql` で管理
- CLI と Web で同じデータ構造を使用する

## ドキュメント更新の原則

### 更新が必要な場合の判断基準

#### 1. 機能の追加・変更
- **影響を受けるドキュメント:**
  - `README.md`
  - `PLAN.md`（フェーズ進捗）
- **変更例:**
  - 新しいアイコンの追加
  - 新しいテーマの追加
  - タイマー機能の変更

#### 2. アーキテクチャの変更
- **影響を受けるドキュメント:**
  - `README.md`
  - `PLAN.md`
  - `CONTRIBUTING.md`
- **変更例:**
  - 新しい依存関係の追加
  - ディレクトリ構造の変更
  - ビルドプロセスの変更

#### 3. 運用手順の変更
- **影響を受けるドキュメント:**
  - `RUNBOOK.md`
  - `CONTRIBUTING.md`
- **変更例:**
  - デプロイ手順の変更
  - テスト手順の変更
  - セットアップ手順の変更

#### 4. ツールやバージョンの更新
- **影響を受けるドキュメント:**
  - `README.md`
  - `RUNBOOK.md`
  - `mise.toml`
- **変更例:**
  - Rust バージョンの変更
  - Node.js バージョンの変更
  - 新しいツールの導入

### ドキュメントマップ

| ドキュメント | 用途 | 更新タイミング |
|------------|------|--------------|
| `README.md` | プロジェクト概要、クイックスタート | 機能追加・セットアップ変更時 |
| `PLAN.md` | 実装計画、フェーズ管理 | フェーズ進捗時 |
| `RUNBOOK.md` | 恒久ルール、標準ワークフロー | ワークフロー・運用ルール変更時 |
| `CONTRIBUTING.md` | 開発フロー、レビュープロセス | Git・PR プロセス変更時 |
| `mise.toml` | ツールバージョン管理 | ツール・バージョン変更時 |

## コミュニケーション

### 確認が必要な場合
- 仕様の曖昧さや判断が必要な事項は複数案とトレードオフを提示して相談する
- 新しい恒久ルールが必要になった場合は「RUNBOOK.md に追記しますか？」と確認する
- 想定外のエラーや問題が発生した場合は即時報告する

### 報告の仕方
- **背景**: なぜこの問題が発生したか
- **現状**: 現在どのような状態か
- **提案**: どのように解決すべきか（複数案を提示）
- **影響**: この問題が他に与える影響

### 進捗の共有
- フェーズ単位で進捗を報告する
- 完了したタスク、進行中のタスク、ブロッカーを明確にする
- RUNBOOK や PLAN の更新が必要な場合は提案する

## 禁止事項

### 絶対にしてはいけないこと
1. **人の承認なく破壊的な操作を実行しない**
   - 本番環境へのデプロイ
   - リソースの削除
   - force push や rebase など Git 履歴を変更する操作

2. **秘密情報を含めない**
   - 認証情報（APIキー、パスワード、トークン）を生成ファイルに含めない
   - 秘密情報をコミットメッセージやコメントに含めない
   - `.gitignore` を確認し、秘匿情報が含まれないようにする

3. **独自ルールを追加しない**
   - RUNBOOK と矛盾する独自ルールを追加しない
   - 新しいルールが必要な場合は人に確認し、RUNBOOK に追記する

4. **勝手な巻き戻しをしない**
   - エラーが発生しても、勝手に `git reset --hard` や `git push --force` をしない
   - 問題を報告し、人の判断を仰ぐ
