# Stripe ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

sandoro ã® Pro ãƒ—ãƒ©ãƒ³æ±ºæ¸ˆæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚ã®æ‰‹é †ã§ã™ã€‚

## æ–™é‡‘ãƒ—ãƒ©ãƒ³

| ãƒ—ãƒ©ãƒ³ | ä¾¡æ ¼ | ç‰¹å¾´ |
|--------|------|------|
| **æœˆé¡** | $1.99/æœˆ | æ‰‹è»½ã«å§‹ã‚ã‚‰ã‚Œã‚‹ |
| **å¹´é¡** | $9.99/å¹´ | 2ãƒ¶æœˆåˆ†ãŠå¾—ï¼ˆå®Ÿè³ª$0.83/æœˆï¼‰ |

### ãƒ‰ãƒãƒ¼ã‚·ãƒ§ãƒ³ã€Œé–‹ç™ºè€…ã«ä¼‘æ†©ã‚’å¥¢ã‚‹ã€

ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¨ã¯åˆ¥ã«ã€é–‹ç™ºè€…ã¸ã®å¿œæ´ã¨ã—ã¦å°‘é¡ã‹ã‚‰æ”¯æ´ã§ãã‚‹ãƒ‰ãƒãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã§ã™ã€‚

| ã‚¢ã‚¤ãƒ†ãƒ  | ä¾¡æ ¼ | èª¬æ˜ |
|---------|------|------|
| â˜• 5åˆ†ä¼‘æ†© | $0.99 | ã¡ã‚‡ã£ã¨æ·±å‘¼å¸ã—ã¦ã­ |
| ğŸµ 15åˆ†ä¼‘æ†© | $2.99 | ãŠèŒ¶ã§ã‚‚é£²ã‚“ã§ã‚†ã£ãã‚Šï¼ |
| ğŸ˜´ æ˜¼å¯ã‚¿ã‚¤ãƒ  | $5.99 | ãŸã¾ã«ã¯ãŒã£ã¤ã‚Šä¼‘ã‚“ã§ |
| ğŸ›ï¸ ãã£ã™ã‚Šç¡çœ  | $9.99 | æ˜æ—¥ã‚‚é ‘å¼µã£ã¦ã­ |

**ç‰¹å…¸**: ç´¯è¨ˆãƒ‰ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒ **$29.99 ä»¥ä¸Š** ã«ãªã‚‹ã¨ã€**Pro æ©Ÿèƒ½ãŒæ°¸ä¹…è§£æ”¾**ã•ã‚Œã¾ã™ï¼

> ä¾‹: $9.99 Ã— 3å› = $29.97 â†’ ã‚ã¨ $0.99 ã§ Pro è§£æ”¾ï¼

> **æ³¨**: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®æ”¯æ‰•ã„é¡ã¨ãƒ‰ãƒãƒ¼ã‚·ãƒ§ãƒ³é¡ã¯åˆ¥ã‚«ã‚¦ãƒ³ãƒˆã§ã™ã€‚

### ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«

- **7æ—¥é–“ã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«**ï¼ˆã‚«ãƒ¼ãƒ‰ç™»éŒ²ä¸è¦ï¼‰
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå¾Œã€è‡ªå‹•çš„ã«ãƒˆãƒ©ã‚¤ã‚¢ãƒ«é–‹å§‹
- ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­ã¯ã™ã¹ã¦ã® Pro æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½
- ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çµ‚äº†å¾Œã¯ Free ãƒ—ãƒ©ãƒ³ã«æˆ»ã‚‹ï¼ˆè‡ªå‹•èª²é‡‘ãªã—ï¼‰

### ã‚³ã‚¹ãƒˆåˆ†æ

| åç›Š | Stripeæ‰‹æ•°æ–™ | å®Ÿåç›Š |
|------|-------------|--------|
| $1.99/æœˆ | $0.37 | $1.62/æœˆ |
| $9.99/å¹´ | $0.66 | $9.33/å¹´ |

**ãƒ‰ãƒãƒ¼ã‚·ãƒ§ãƒ³**

| åç›Š | Stripeæ‰‹æ•°æ–™ | å®Ÿåç›Š |
|------|-------------|--------|
| $0.99 | $0.33 | $0.66 |
| $2.99 | $0.39 | $2.60 |
| $5.99 | $0.48 | $5.51 |
| $9.99 | $0.60 | $9.39 |

> æ³¨: Stripe æ‰‹æ•°æ–™ã¯ 2.9% + $0.30/å›

## 1. Stripe ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

1. [Stripe Dashboard](https://dashboard.stripe.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆï¼ˆã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³ï¼‰
3. **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰** ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆå³ä¸Šã®ãƒˆã‚°ãƒ«ï¼‰

## 2. Product ã¨ Price ã®ä½œæˆ

### Stripe Dashboard ã§ä½œæˆ

1. **Products** â†’ **Add product** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ä»¥ä¸‹ã®å•†å“ã‚’ä½œæˆ:

#### sandoro Proï¼ˆã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

| é …ç›® | å€¤ |
|------|-----|
| Name | sandoro Pro |
| Description | ASCII art pomodoro timer - Pro features |

**Price 1: Monthly**
- Pricing model: Standard pricing
- Price: $1.99 USD
- Billing period: Monthly
- **Price ID ã‚’ãƒ¡ãƒ¢** (ä¾‹: `price_1abc123...`)

**Price 2: Yearly**
- Pricing model: Standard pricing
- Price: $9.99 USD
- Billing period: Yearly
- **Price ID ã‚’ãƒ¡ãƒ¢**

#### ãƒ‰ãƒãƒ¼ã‚·ãƒ§ãƒ³ã€Œé–‹ç™ºè€…ã«ä¼‘æ†©ã‚’å¥¢ã‚‹ã€

| é …ç›® | å€¤ |
|------|-----|
| Name | sandoro Donation |
| Description | Support the developer with a break! |

ä»¥ä¸‹ã®4ã¤ã® Price ã‚’ä½œæˆï¼ˆã™ã¹ã¦ One-timeï¼‰:

| Price å | ä¾¡æ ¼ | ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ |
|---------|------|-----------|
| 5åˆ†ä¼‘æ†© | $0.99 USD | `donation_type: break_5min` |
| 15åˆ†ä¼‘æ†© | $2.99 USD | `donation_type: break_15min` |
| æ˜¼å¯ã‚¿ã‚¤ãƒ  | $5.99 USD | `donation_type: nap` |
| ãã£ã™ã‚Šç¡çœ  | $9.99 USD | `donation_type: sleep` |

> **é‡è¦**: å„ Price ã® **Price ID ã‚’ãƒ¡ãƒ¢**ã—ã¦ãŠã

## 3. Webhook è¨­å®š

1. **Developers** â†’ **Webhooks** â†’ **Add endpoint**
2. Endpoint URL: `https://<your-project-ref>.supabase.co/functions/v1/stripe-webhook`
3. Events to send:
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_failed`
4. **Signing secret ã‚’ãƒ¡ãƒ¢** (ä¾‹: `whsec_...`)

## 4. Customer Portal è¨­å®š

1. **Settings** â†’ **Billing** â†’ **Customer portal**
2. ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ–:
   - âœ… Allow customers to update their payment methods
   - âœ… Allow customers to view their invoice history
   - âœ… Allow customers to cancel subscriptions
3. **Save changes**

## 5. Supabase Edge Functions ã®ç’°å¢ƒå¤‰æ•°è¨­å®š

1. [Supabase Dashboard](https://supabase.com/dashboard) â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
2. **Edge Functions** â†’ **Secrets**
3. ä»¥ä¸‹ã®ç§˜å¯†æƒ…å ±ã‚’è¿½åŠ :

| Name | Value |
|------|-------|
| `STRIPE_SECRET_KEY` | `sk_test_...` (Stripe Dashboard â†’ Developers â†’ API keys) |
| `STRIPE_WEBHOOK_SECRET` | `whsec_...` (Step 3 ã§ãƒ¡ãƒ¢ã—ãŸã‚‚ã®) |

> **æ³¨**: `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` ã¯è‡ªå‹•ã§è¨­å®šã•ã‚Œã¾ã™ã€‚

## 6. Web ã‚¢ãƒ—ãƒªã®ç’°å¢ƒå¤‰æ•°è¨­å®š

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ (.env.local)

```bash
# web/.env.local
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_...

# Pro subscription prices
VITE_STRIPE_PRICE_MONTHLY=price_...
VITE_STRIPE_PRICE_YEARLY=price_...

# Donation prices
VITE_STRIPE_PRICE_DONATION_5MIN=price_...
VITE_STRIPE_PRICE_DONATION_15MIN=price_...
VITE_STRIPE_PRICE_DONATION_NAP=price_...
VITE_STRIPE_PRICE_DONATION_SLEEP=price_...
```

### Vercel æœ¬ç•ªç’°å¢ƒ

1. Vercel Dashboard â†’ Settings â†’ Environment Variables
2. ä¸Šè¨˜ã¨åŒã˜å¤‰æ•°ã‚’è¿½åŠ ï¼ˆæœ¬ç•ªã¯ `pk_live_...` ã‚’ä½¿ç”¨ï¼‰

## 7. Edge Functions ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# Supabase CLI ã§ãƒ­ã‚°ã‚¤ãƒ³
npx supabase login

# Functions ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ--no-verify-jwt ãƒ•ãƒ©ã‚°ãŒå¿…è¦ï¼‰
npx supabase functions deploy create-checkout --no-verify-jwt
npx supabase functions deploy create-donation-checkout --no-verify-jwt
npx supabase functions deploy stripe-webhook --no-verify-jwt
npx supabase functions deploy customer-portal --no-verify-jwt
```

> **é‡è¦**: `--no-verify-jwt` ãƒ•ãƒ©ã‚°ã¯å¿…é ˆã§ã™ã€‚ã“ã®ãƒ•ãƒ©ã‚°ãŒãªã„ã¨ã€Supabase ã®ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¬ãƒ™ãƒ«ã§ JWT æ¤œè¨¼ãŒè¡Œã‚ã‚Œã€Edge Function å†…ã§ã®èªè¨¼å‡¦ç†ã¨ç«¶åˆã—ã¦ 401 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚Edge Function å†…ã§ç‹¬è‡ªã« JWT ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ã€‚

## 8. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```bash
npx supabase db push --project-ref <your-project-ref>
```

## 9. ãƒ†ã‚¹ãƒˆ

### ãƒ†ã‚¹ãƒˆç”¨ã‚«ãƒ¼ãƒ‰ç•ªå·

| ã‚·ãƒŠãƒªã‚ª | ã‚«ãƒ¼ãƒ‰ç•ªå· |
|---------|-----------|
| æˆåŠŸ | `4242 4242 4242 4242` |
| èªè¨¼å¿…è¦ | `4000 0025 0000 3155` |
| å¤±æ•— | `4000 0000 0000 0002` |

æœ‰åŠ¹æœŸé™: ä»»æ„ã®æœªæ¥æ—¥ã€CVC: ä»»æ„ã®3æ¡

## æœ¬ç•ªç§»è¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] Stripe Dashboard ã§ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ **OFF** ã«
- [ ] æœ¬ç•ªç”¨ API ã‚­ãƒ¼ã«å·®ã—æ›¿ãˆ
- [ ] Webhook endpoint ã‚’æœ¬ç•ª URL ã«æ›´æ–°
- [ ] æœ¬ç•ªç”¨ Webhook signing secret ã«æ›´æ–°
- [ ] Vercel ç’°å¢ƒå¤‰æ•°ã‚’æœ¬ç•ªç”¨ã«æ›´æ–°

## è¿”é‡‘å¯¾å¿œï¼ˆæ‰‹å‹•ï¼‰

è¿”é‡‘ã¯ Stripe Dashboard ã§æ‰‹å‹•å¯¾å¿œã—ã¾ã™ã€‚

### è¿”é‡‘æ‰‹é †

1. [Stripe Dashboard](https://dashboard.stripe.com) â†’ **Payments**
2. è©²å½“ã®æ”¯æ‰•ã„ã‚’ã‚¯ãƒªãƒƒã‚¯
3. å³ä¸Šã® **Refund** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. è¿”é‡‘é¡ã‚’å…¥åŠ›ï¼ˆå…¨é¡ or ä¸€éƒ¨ï¼‰
5. ç†ç”±ã‚’é¸æŠã—ã¦ **Refund** ã‚’å®Ÿè¡Œ

### è¿”é‡‘å¾Œã®å¯¾å¿œ

**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®å ´åˆ**:
- è¿”é‡‘ã—ã¦ã‚‚è‡ªå‹•çš„ã«ã‚µãƒ–ã‚¹ã‚¯ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã›ã‚“
- å¿…è¦ã«å¿œã˜ã¦ **Subscriptions** ã‹ã‚‰æ‰‹å‹•ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- Webhook ãŒ `customer.subscription.deleted` ã‚’å—ä¿¡ã—ã€DB ã® status ãŒ `canceled` ã«æ›´æ–°ã•ã‚Œã¾ã™

**ãƒ‰ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®å ´åˆ**:
- è¿”é‡‘ã—ã¦ã‚‚ donations ãƒ†ãƒ¼ãƒ–ãƒ«ã¯è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã›ã‚“
- å¿…è¦ã«å¿œã˜ã¦ Supabase ã® Table Editor ã§ status ã‚’ `refunded` ã«æ‰‹å‹•å¤‰æ›´

### è¿”é‡‘ãƒãƒªã‚·ãƒ¼ï¼ˆæ¨å¥¨ï¼‰

- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³: è³¼å…¥å¾Œ7æ—¥ä»¥å†…ã¯å…¨é¡è¿”é‡‘
- ãƒ‰ãƒãƒ¼ã‚·ãƒ§ãƒ³: åŸå‰‡è¿”é‡‘ä¸å¯ï¼ˆå¯„ä»˜ã®æ€§è³ªä¸Šï¼‰

> **æ³¨**: è¿”é‡‘è‡ªå‹•åŒ–ãŒå¿…è¦ãªå ´åˆã¯ `charge.refunded` Webhook ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 401 "Invalid JWT" ã‚¨ãƒ©ãƒ¼
- Edge Functions ãŒ `--no-verify-jwt` ãƒ•ãƒ©ã‚°ãªã—ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§
- å†ãƒ‡ãƒ—ãƒ­ã‚¤: `npx supabase functions deploy <function-name> --no-verify-jwt`

### Edge Function ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ / WORKER_ERROR
- Stripe SDK ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒé‡ã™ãã‚‹å¯èƒ½æ€§
- `stripe@13.10.0` ã‚’ä½¿ç”¨ï¼ˆv14 ä»¥é™ã¯ Deno ç’°å¢ƒã§å•é¡Œã‚ã‚Šï¼‰
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¾‹: `import Stripe from 'https://esm.sh/stripe@13.10.0?target=deno&deno-std=0.177.0';`

### Webhook ãŒå±Šã‹ãªã„
- Endpoint URL ãŒæ­£ã—ã„ã‹ç¢ºèª
- Supabase Edge Functions ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- Stripe Dashboard â†’ Webhooks â†’ è©²å½“ endpoint â†’ Recent events ã§ç¢ºèª
- `--no-verify-jwt` ãƒ•ãƒ©ã‚°ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒ‰ãƒãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«ç´¯è¨ˆãŒæ›´æ–°ã•ã‚Œãªã„
- donations ãƒ†ãƒ¼ãƒ–ãƒ«ã« pending ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- Webhook ãŒ 200 ã‚’è¿”ã—ã¦ã„ã‚‹ã‹ Stripe Dashboard ã§ç¢ºèª
- ãƒ­ã‚°ç¢ºèª: `npx supabase functions logs stripe-webhook`
- Webhook ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†é€ã—ã¦å‹•ä½œç¢ºèª

### è³¼å…¥å¾Œã« Pro ã«ãªã‚‰ãªã„
- Supabase â†’ Table Editor â†’ subscriptions ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
- Edge Functions ã®ãƒ­ã‚°ã‚’ç¢ºèª: `npx supabase functions logs stripe-webhook`

### CORS ã‚¨ãƒ©ãƒ¼
- Edge Functions ã® `corsHeaders` ã« origin ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### Supabase CLI "Access token not provided" ã‚¨ãƒ©ãƒ¼
- `npx supabase login` ã§å†ãƒ­ã‚°ã‚¤ãƒ³
- ã¾ãŸã¯ Dashboard ã§ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ: https://supabase.com/dashboard/account/tokens
- `export SUPABASE_ACCESS_TOKEN=your_token` ã§è¨­å®š
